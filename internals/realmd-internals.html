<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>realmd Internals</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article"><div class="titlepage"><div><div><h2 class="title"><a name="index"></a>realmd Internals</h2></div><div><p class="releaseinfo">January, 2013</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#overview">Overview</a></span></dt><dt><span class="section"><a href="#objects-interfaces">Realmd Objects and Interfaces</a></span></dt><dt><span class="section"><a href="#discover">Discover method</a></span></dt><dt><span class="section"><a href="#provider">RealmProvider</a></span></dt><dt><span class="section"><a href="#join">Join method</a></span></dt><dt><span class="section"><a href="#kerberos">RealmKerberos</a></span></dt><dt><span class="section"><a href="#exporting">Exporting Realmd Objects and Interfaces</a></span></dt><dt><span class="section"><a href="#example">Example Provider</a></span></dt><dt><span class="section"><a href="#missing">Missing</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview"></a>Overview</h2></div></div></div><p>realmd is an on-demand system D-Bus service, whose primary purpose is
	to enable Linux to work seamlessly out of the box with network authentication
	realms (like Kerberos, with primary focus on AD and IPA). Specifically, the
	realmd service supports discovering a domain, joining a domain, leaving a
	domain, and more.</p><p>Currently there is only support for Kerberos realms.</p><p>Some of the D-Bus clients that interact with realmd are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>command line realm client</p></li><li class="listitem"><p>gnome-control-center GUI client</p></li><li class="listitem"><p>gdm</p></li><li class="listitem"><p>anaconda</p></li></ul></div><p>Realmd can be run in two different modes (with some slight changes in
	behavior depending on the mode)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>At install time (e.g. using an anaconda kickstart file).
		In this mode, since the system message bus may not be available, the
		realm client directly spawns realmd and communicates with it using the
		D-Bus peer protocol (i.e. without going through the message bus).</p></li><li class="listitem"><p>After installation. In this mode, the system message
		bus is available and is used to forward messages from the realm client
		to realmd.</p></li></ul></div><p>Realmd is typically used (whether at install time or afterwards) by a D-Bus
	client to discover the KDC for a Kerberos domain and to join the machine to that
	domain using membership software. This will involve changes on the server made by
	server software, as well as artifacts (keytab, configuration file)  that are output
	by realmd on the machine for consumption by client software that will subsequently
	be responsible for Kerberos authentication.</p><p>For active-directory server software, realmd supports:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>sssd client software (with either adcli or samba membership software)</p></li><li class="listitem"><p>winbind client software (with samba membership software).</p></li></ul></div><p>For IPA server software, realmd supports:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>sssd client software (with 'ipa' membership software).</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="objects-interfaces"></a>Realmd Objects and Interfaces</h2></div></div></div><p>A GDBusObject is associated with an object path and is essentially a container
	of GDBusInterfaces. On the service side, this is implemented using GDBusObjectSkeletons
	and GDBusInterfaceSkeletons (with corresponding GDBusObjectProxy and GDBusProxy
	components on the client side). The base GDBusObjectSkeletons used by realmd are
	RealmKerberos and RealmProvider (each with its own subclasses and interfaces). The
	objects are linked, in that a RealmProvider object creates a RealmKerberos object
	during the Discover process. The type of RealmKerberos object that is created depends
	on the type of RealmProvider that is used. Only those RealmKerberos objects that
	implement the RealmKerberosMembership GInterface can be used to join or leave a domain.</p><div class="variablelist"><p class="title"><b>RealmKerberos</b></p><dl class="variablelist"><dt><span class="term">RealmDbusRealm</span></dt><dd><p>supports Deconfigure and ChangeLoginPolicy methods</p></dd><dt><span class="term">RealmDbusKerberosMembership</span></dt><dd><p>supports Join and Leave methods</p></dd><dt><span class="term">RealmDbusKerberos</span></dt><dd><p>supports no methods (properties only)</p></dd><dt><span class="term">RealmSamba</span></dt><dd><p>implements RealmKerberosMembership</p></dd><dt><span class="term">RealmSssd</span></dt><dd><p>container for RealmSssdAd and RealmSssdIpa</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">subclass: RealmSssdAd</span></dt><dd><p>implements RealmKerberosMembership</p></dd><dt><span class="term">subclass: RealmSssdIpa</span></dt><dd><p>implements RealmKerberosMembership</p></dd></dl></div></dd></dl></div><div class="variablelist"><p class="title"><b>RealmProvider</b></p><dl class="variablelist"><dt><span class="term">RealmDbusProvider</span></dt><dd><p>supports Discover method</p></dd><dt><span class="term">RealmSambaProvider</span></dt><dd><p>creates RealmSamba objects</p></dd><dt><span class="term">RealmSssdProvider</span></dt><dd><p>creates RealmSssdAd and RealmSssdIpa objects</p></dd><dt><span class="term">RealmKerberosProvider</span></dt><dd><p>creates RealmKerberos objects</p></dd><dt><span class="term">RealmAllProvider</span></dt><dd><p>aggregates other RealmProviders</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="discover"></a>Discover method</h2></div></div></div><div class="mediaobject"><img src="discover-method.png"></div><p>The main purpose of the Discover method is to verify that a specified domain
	is valid, emitting logs and diagnostic information in the process. RealmProviders
	discover the authoritative KDCs for the specified domain by querying DNS for SRV
	records and creating appropriate RealmKerberos objects to encapsulate the KDC
	information. Certain types of RealmKerberos objects (i.e. RealmSamba and RealmSssdAd)
	can subsequently be used as part of the Join process.</p><p>RealmAllProvider is special in that it serves all realm types. A client that wants to use all
	of the RealmProviders (Samba, Sssd, Kerberos) can contact each RealmProvider (at its
	unique object path). Alternatively and usually, the client simply contacts the RealmAllProvider,
	which is special in that it serves as an aggregation point and container for all of
	the other RealmProviders. When Discover is called on RealmAllProvider, it calls
	the Discover methods of each of the other RealmProviders, collects the results
	(array of RealmKerberos objects), and returns an aggregated result (array of object
	paths pointing to RealmKerberos objects) to the client. The AllProvider also connects
	to a notify signal, so that if any of its sub-providers change state, AllProvider
	can also update its state accordingly.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="provider"></a>RealmProvider</h2></div></div></div><p>A RealmProvider object supports the Discover method, and is characterized by:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>its object path (static)</p></li><li class="listitem"><p>the combinations of {client, server, membership} software it supports for the Discover process</p></li><li class="listitem"><p>the types of RealmKerberos objects it creates during the Discover process</p></li><li class="listitem"><p>the file it uses to read/write configuration information</p></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmSambaProvider</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path: "/org/freedesktop/realmd/Samba"</p></li><li class="listitem"><p>creates: RealmSamba objects</p></li><li class="listitem"><p>config file read: smb.conf</p></li><li class="listitem"><p>software supported: {winbind, active-directory, samba}</p></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmSssdProvider</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path: "/org/freedesktop/realmd/Sssd"</p></li><li class="listitem"><p>creates: RealmSssdAd objects or RealmSssdIpa objects (depending on server-software)</p></li><li class="listitem"><p>config file read: sssd.conf</p></li><li class="listitem"><p>software supported</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>{sssd, active-directory, samba}</p></li><li class="listitem"><p>{sssd, active-directory, adcli}</p></li><li class="listitem"><p>{sssd, ipa, ipa}</p></li></ul></div></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmKerberosProvider</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path: "/org/freedesktop/realmd/GenericKerberos"</p></li><li class="listitem"><p>creates: RealmKerberos objects</p></li><li class="listitem"><p>config file read: n/a</p></li><li class="listitem"><p>software supported: none, so only used if client-software and server-software were not specified</p></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmAllProvider</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path: &#8220;/org/freedesktop/realmd&#8221;</p></li><li class="listitem"><p>special RealmProvider that aggregates results (see <a class="link" href="#discover" title="Discover method">Discover() method</a>)</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="join"></a>Join method</h2></div></div></div><div class="mediaobject"><img src="join-method.png"></div><p>The primary goal of joining a machine to a domain is to enroll the machine
	with the domain's KDC, thereby enabling subsequent Kerberos user authentication.
	This results in the creation of a secret shared between the machine and KDC (i.e.
	a keytab), as well as changes to the appropriate configuration file on the machine.
	Conversely, the primary goal of leaving a domain is to unenroll the machine from
	the domain's KDC, removing the keytab and removing the changes that were previously
	made to the appropriate configuration file during enrollment. Both the join and
	leave operations require appropriate credentials, where each credential is represented
	by the credential owner and the credential type. Different RealmKerberos objects
	support different credentials, and different credentials may be supported for join
	and leave. Before performing the join, any required packages or files are installed.</p><p>Possible credential owners: admin, user, computer, none</p><p>Possible credential types: password, secret (otp), automatic (default/system creds)</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="kerberos"></a>RealmKerberos</h2></div></div></div><p>A RealmKerberos object supports the Join, Leave, Deconfigure, and
	ChangeLoginPolicy methods. It is characterized by:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>its object path (dynamic, per realm)</p></li><li class="listitem"><p>the membership software it supports</p></li><li class="listitem"><p>the configuration file it modifies</p></li><li class="listitem"><p>the packages it requires to be installed</p></li><li class="listitem"><p>the credentials it supports: {owner, type}</p></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmSamba</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path example: /realmd/Samba/example.com_4</p></li><li class="listitem"><p>membership software supported: samba</p></li><li class="listitem"><p>config file modified: smb.conf</p></li><li class="listitem"><p>required packages: samba, winbind</p></li><li class="listitem"><p>credentials supported: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>{admin, password}</p></li><li class="listitem"><p>{user, password}</p></li><li class="listitem"><p>{none, automatic}</p></li></ul></div></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmSssdAd</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>object path example: /realmd/Sssd/example.com_4</p></li><li class="listitem"><p>membership software supported: samba, adcli (but only for certain credentials: see below)</p></li><li class="listitem"><p>config file modified: sssd.conf</p></li><li class="listitem"><p>required_packages: sssd, adcli, samba (depends on membership software)</p></li><li class="listitem"><p>credentials supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>{admin, password}	// supported by both samba (default) and adcli</p></li><li class="listitem"><p>{user, password}		// supported only by samba</p></li><li class="listitem"><p>{none, automatic}	// supported only by adcli</p></li><li class="listitem"><p>{none, secret}		// supported only by adcli; note that these are supported for join, but not leave</p></li></ul></div></li></ul></div><div class="itemizedlist"><p class="title"><b>RealmSssdIpa</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>has a dynamically generated object path upon realm creation.</p></li><li class="listitem"><p>membership software supported: ipa</p></li><li class="listitem"><p>config file modified: sssd.conf</p></li><li class="listitem"><p>required_packages: sssd, freeipa-client</p></li><li class="listitem"><p>credentials supported: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>{admin, password}</p></li><li class="listitem"><p>{none, secret} // one time password</p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exporting"></a>Exporting Realmd Objects and Interfaces</h2></div></div></div><p>When realmd starts up (realm-daemon.c:main), it registers each of its
	RealmProviders (except RealmAllProvider) with its GDBusObjectManagerServer,
	which in turn exports (onto a specific object path) the GDBusInterfaces for
	each RealmProvider onto the GDBusConnection. As RealmKerberos objects are
	dynamically created, they are similarly registered with the Object Manager
	and exported. </p><p>Note that only GDBusInterfaces that are exported onto the GDBusConnection
	are capable of receiving method call messages from the client. When a message
	is received by the worker thread of the service's GDBusConnection, the message's
	{object_path, iface_name} are mapped to a GDBusInterfaceSkeleton, which emits
	a signal. The enclosing GDBusObjectSkeleton catches the signal and executes the
	callback registered for that signal (usually set in RealmProvider's constructed
	method).</p><p>Since RealmAllProvider is just an aggregation point, it is not managed by
	the GDBusObjectManagerServer,but it is directly exported onto the GDBusConnection
	using g_dbus_connection_register_object(). The ObjectManager and Service objects
	are also directly exported onto the GDBusConnection.</p><p>The following is a subset of objects and interfaces registered with the
	GDBusObjectManagerServer and/or exported onto the GDBusConnection.</p><p>GDBusConnection: stores {object_path, iface_name} =&gt; GDBusInterfaceSkeleton</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>{/org/freedesktop/realmd, org.freedesktop.realmd.Provider}	=&gt; RealmDbusProviderSkeleton(&#8220;All&#8221;)</p></li><li class="listitem"><p>{/org/freedesktop/realmd, org.freedesktop.realmd.Service}	=&gt; RealmDbusServiceSkeleton</p></li><li class="listitem"><p>{/org/freedesktop/realmd, org.freedesktop.DBus.ObjectManager} =&gt; GDBusObjectManagerServer</p></li></ul></div><p>GDBusObjectManagerServer: stores object_path =&gt; GDBusObjectSkeleton</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>/org/freedesktop/realmd/Sssd				=&gt;	RealmSssdProvider</p></li><li class="listitem"><p>/org/freedesktop/realmd/Samba				=&gt;	RealmSambaProvider</p></li><li class="listitem"><p>/org/freedesktop/realmd/GenericKerberos		=&gt;	RealKerberosProvider</p></li><li class="listitem"><p>/org/freedesktop/realmd/Sssd/example.com_4 	=&gt;	RealmSssdAd</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example"></a>Example Provider</h2></div></div></div><p>realmd includes a rough example provider, which can be used as a mock
	provider for testing against. It is disabled by default. The example provider
	discovers realms that match <code class="literal">*example.com</code>.</p><p>Set the <code class="option">example</code> setting to <code class="literal">yes</code> in
	the <code class="option">[providers]</code> section of the settings to enable it.</p><div class="informalexample"><pre class="programlisting">
[providers]
example = yes
# example = no
</pre></div><p>Some settings of the example provider.</p><div class="informalexample"><pre class="programlisting">
[example]
# What domain to return for a default discovery
default = default.example.com
# How long to delay a successful discovery, in seconds
example-discovery-delay = 1.3
# How long to delay a unsuccessful disocvery
example-non-discovery-delay = 0.9
</pre></div><p>You can tweak various options per example realm.</p><div class="informalexample"><pre class="programlisting">
[default.example.com]
# Mock administrator account required to join
example-administrator = Administrator
# Password for above mock admin account
example-password = bureaucracy
# How long to delay when joining this domain, in seconds.
example-join-delay = 2.5
# How long to delay when leaving
example-leave-delay = 1
# Whether to disallow leaving without a password
example-no-auto-leave = yes
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="missing"></a>Missing</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Description of ChangeLoginPolicy method</p></li><li class="listitem"><p>Description of all the methods for the Service object</p></li><li class="listitem"><p>Details of realmd.conf (man page, perhaps)</p></li><li class="listitem"><p>Details of configuration files (sssd.conf, smb.conf) and relevant entries</p></li></ul></div></div></div></body></html>
